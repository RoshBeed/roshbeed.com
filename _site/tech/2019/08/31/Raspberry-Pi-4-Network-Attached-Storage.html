<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Raspberry Pi 4 Network Attached Storage</title>
  <meta name="description" content="DevOps Engineer">

  <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
  <link rel="manifest" href="/img/favicon/manifest.json">
  <link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#131d28">
  <link rel="shortcut icon" href="/img/favicon/favicon.ico">
  <meta name="apple-mobile-web-app-title" content="Rosh Beedassee">
  <meta name="application-name" content="Rosh Beedassee">
  <meta name="msapplication-config" content="/img/favicon/browserconfig.xml">
  <meta name="theme-color" content="#131d28">

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/flexboxgrid/6.3.1/flexboxgrid.min.css" type="text/css" >
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css">
  <link rel="stylesheet" href="//cdn.rawgit.com/konpa/devicon/master/devicon.min.css" type="text/css">
  <link rel="stylesheet" href="/css/main.css">
</head>


<body>
    <a href="/">
        <div id="particles-js" class="particles-small">
            <div class="post-title">
                <h1 class="site-title">Rosh Beedassee</h1>
            </div>
        </div>
    </a>
    <div class="content">
        <section id="post">
            <div class="container post">
                <h2>Raspberry Pi 4 Network Attached Storage</h2>
                <img alt="Network Cables" src="/img/Raspberry-Pi-Network-Attached-Storage/Raspberry-Pi-Network-Attached-Storage-1.jpg" />
                <p>Iâ€™m on a quest to find cost-effective ways to store my data. The offerings from cloud providers are enticing, but the subscription payment method can cost a lot over time. Pre-built NAS boxes another option, but they come with a high upfront cost. I decided to create a storage solution using a Raspberry Pi 4 and an SSD drive. In this post, learn how to store data in a centralised location within a local area network and access that data from other devices.</p>

<h2 id="content">Content</h2>

<ul>
  <li><a href="#raspberry-pi-setup">Raspberry Pi Setup</a></li>
  <li><a href="#ssh-setup">SSH Setup</a></li>
  <li><a href="#nfs-server-setup">NFS Server Setup</a></li>
  <li><a href="#disk-setup">Disk Setup</a></li>
  <li><a href="#nfs-client-setup">NFS Client Setup</a></li>
  <li><a href="#software-used">Software used</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="raspberry-pi-setup">Raspberry Pi Setup</h2>

<p>We must install the Raspbian operating system and enable SSH onto the Raspberry Pi.</p>

<p>Download latest Raspbian image</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wget https://downloads.raspberrypi.org/raspbian_lite_latest
</code></pre></div></div>

<p>Extract the image</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ unzip raspbian_lite_latest
</code></pre></div></div>

<p>Write image to our SD card</p>
<pre>
# dd if=./*raspbian*.img of=/dev/sd<b>&lt;XX&gt;</b>
</pre>

<p>Mount the boot partition from our SD card</p>
<pre>
# mount /dev/sd<b>&lt;X&gt;</b>1 ./boot
</pre>

<p>Enable SSH</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ touch ./boot/ssh
</code></pre></div></div>

<p>Unmount boot partition</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ umount ./boot
</code></pre></div></div>

<p>Clean up files no longer needed</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rm *raspbian*
</code></pre></div></div>

<p>The SD card has been prepared. We have configured it start SSH.</p>

<p>Insert the SD card into our Raspberry Pi and connect the power supply.</p>

<h2 id="ssh-setup">SSH Setup</h2>
<p>Setup the SSH connection.</p>

<pre>
ssh-keygen -q -t rsa -f $HOME/.ssh/id_rsa -P "<b>&lt;passphrase&gt;</b>"
</pre>

<p>Copy SSH public key to Raspberry Pi</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh-copy-id pi@raspberrypi.local
</code></pre></div></div>

<p>SSH into Raspberry Pi</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh pi@raspberrypi.local
</code></pre></div></div>

<p>Change the default password to something secure</p>

<pre>
# echo 'pi:<b>&lt;newpassword&gt;</b>' | chpasswd
</pre>

<p>Disable SSH password authentication</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo grep -q "^[^#]*PasswordAuthentication" /etc/ssh/sshd_config &amp;&amp; sed -i "/^[^#]*PasswordAuthentication[[:space:]]yes/c\PasswordAuthentication no" /etc/ssh/sshd_config || echo "PasswordAuthentication no" &gt;&gt; /etc/ssh/sshd_config
$ systemctl restart sshd
</code></pre></div></div>

<h2 id="disk-setup">Disk Setup</h2>

<p>We need to format our disk drive and mount it before we can share it on the network.</p>

<p>Format Disk to ext4</p>
<pre>
# mkfs.ext4 /dev/sd<b>&lt;X&gt;</b>1
</pre>

<p>Create NFS mountpoint</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># mkdir /media/nfs
</code></pre></div></div>

<p>Mount Disk</p>
<pre>
# mount /dev/sd<b>&lt;X&gt;</b>1 /media/nfs
</pre>

<p>Mounting at boot</p>
<pre>
# echo "/dev/sd<b>&lt;X&gt;</b>1 /media/nfs ext4 defaults 0 0" &gt;&gt; /etc/fstab
</pre>

<h2 id="nfs-server-setup">NFS Server Setup</h2>
<p>NFS is a client/server application which allows us to share directories over the network.</p>

<p>Install NFS server</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># apt-get update -y &amp;&amp; apt-get install nfs-kernel-server
</code></pre></div></div>

<p>Add directory to <code class="highlighter-rouge">/etc/exports</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo "/media/nfs *(ro,all_squash,insecure)" &gt;&gt; /etc/exports
</code></pre></div></div>

<p>Re-export changes</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># exportfs -arv
</code></pre></div></div>

<h2 id="nfs-client-setup">NFS Client Setup</h2>

<p>Install the components required for the NFS client</p>

<p>Arch:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -Syu nfs-utils
</code></pre></div></div>

<p>Ubuntu:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># apt-get install nfs-common
</code></pre></div></div>

<p>Create a mountpoint</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># mkdir /media/nfs /media/nfs
</code></pre></div></div>

<p>Mount the NFS share on the client</p>
<pre>
# mount raspberrypi.local:/media/nfs /media/nfs
</pre>

<p>Mounting at boot</p>
<pre>
# echo "raspberrypi.local:/media/nfs /media/nfs nfs defaults 0 0" &gt;&gt; /etc/fstab
</pre>

<h2 id="software-used">Software used</h2>
<ul>
  <li><a href="https://tools.ietf.org/html/rfc7530">nfs</a></li>
  <li><a href="https://www.openssh.com/">ssh</a></li>
</ul>

<h2 id="conclusion">Conclusion</h2>
<p>The latest Raspberry Pi now has USB 3 as well as Gigabit networking which is a vast improvement over the previous models. The ability to create high throughput network storage with Raspberry Pis is now possible.</p>

<p>NFS is not fast by default. Optimisations can improve performance. Other protocols (e.g. rsync) may offer better performance.</p>

<p>This was a quick tutorial on how to setup NFS. The next steps are to secure the  NFS share. Overall it was a successful project. It was cheaper than a pre-built NAS box.</p>

            </div>
        </section>
    </div>
    <footer class="footer">
    <p>&copy; Rosh Beedassee</p>
</footer>
<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="//cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="/js/app.js"></script>

<!-- Matomo -->
<script type="text/javascript">
    var _paq = _paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
        var u="//matomo-analytics.herokuapp.com/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
    })();
</script>
<!-- End Matomo Code -->

</body>

</html>
