<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Raspberry Pi 4 Network Attached Storage</title>
  <meta name="description" content="DevOps Engineer">

  <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
  <link rel="manifest" href="/img/favicon/manifest.json">
  <link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#131d28">
  <link rel="shortcut icon" href="/img/favicon/favicon.ico">
  <meta name="apple-mobile-web-app-title" content="Rosh Beedassee">
  <meta name="application-name" content="Rosh Beedassee">
  <meta name="msapplication-config" content="/img/favicon/browserconfig.xml">
  <meta name="theme-color" content="#131d28">

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/flexboxgrid/6.3.1/flexboxgrid.min.css" type="text/css" >
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css">
  <link rel="stylesheet" href="//cdn.rawgit.com/konpa/devicon/master/devicon.min.css" type="text/css">
  <link rel="stylesheet" href="/css/main.css">
</head>


<body>
    <a href="/">
        <div id="particles-js" class="particles-small">
            <div class="post-title">
							 <img class="small-profile" src="/img/profile.png"></img>
                <h1 class="site-title">Rosh Beedassee</h1>
            </div>
        </div>
    </a>
    <div class="content">
        <section id="post">
            <div class="container post">
                <h1>Raspberry Pi 4 Network Attached Storage</h1>
                <img alt="Network Cables" src="/img/Raspberry-Pi-Network-Attached-Storage/Raspberry-Pi-Network-Attached-Storage-1.jpg" />
                <p>Iâ€™m on a quest to find cost-effective ways to store my data. The offerings from cloud providers are enticing, but the subscription payment method can cost a lot over time. Pre-built NAS boxes another option, but they come with a high upfront cost. I decided to create a storage solution using a Raspberry Pi 4 and an SSD drive. In this post, learn how to store data in a centralised location within a local area network and access that data from other devices.</p>

<h2 id="content">Content</h2>

<ul>
  <li><a href="#raspberry-pi-setup">Raspberry Pi Setup</a></li>
  <li><a href="#ssh-setup">SSH Setup</a></li>
  <li><a href="#nfs-server-setup">NFS Server Setup</a></li>
  <li><a href="#disk-setup">Disk Setup</a></li>
  <li><a href="#nfs-client-setup">NFS Client Setup</a></li>
  <li><a href="#software-used">Software used</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="raspberry-pi-setup">Raspberry Pi Setup</h2>

<p>We must install the Raspbian operating system and enable SSH onto the Raspberry Pi.</p>

<p>Download latest Raspbian image</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wget https://downloads.raspberrypi.org/raspbian_lite_latest
</code></pre></div></div>

<p>Extract the image</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ unzip raspbian_lite_latest
</code></pre></div></div>

<p>Write image to our SD card</p>
<pre>
# dd if=./*raspbian*.img of=/dev/sd<b>&lt;XX&gt;</b>
</pre>

<p>Mount the boot partition from our SD card</p>
<pre>
# mount /dev/sd<b>&lt;X&gt;</b>1 ./boot
</pre>

<p>Enable SSH</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ touch ./boot/ssh
</code></pre></div></div>

<p>Unmount boot partition</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ umount ./boot
</code></pre></div></div>

<p>Clean up files no longer needed</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rm *raspbian*
</code></pre></div></div>

<p>The SD card has been prepared. We have configured it start SSH.</p>

<p>Insert the SD card into our Raspberry Pi and connect the power supply.</p>

<h2 id="ssh-setup">SSH Setup</h2>
<p>Setup the SSH connection.</p>

<pre>
$ ssh-keygen -q -t rsa -f $HOME/.ssh/id_rsa -P "<b>&lt;passphrase&gt;</b>"
</pre>

<p>Copy SSH public key to Raspberry Pi</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh-copy-id pi@raspberrypi.local
</code></pre></div></div>

<p>SSH into Raspberry Pi</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh pi@raspberrypi.local
</code></pre></div></div>

<p>Change the default password to something secure</p>

<pre>
# echo 'pi:<b>&lt;newpassword&gt;</b>' | chpasswd
</pre>

<p>Disable SSH password authentication</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -q "^[^#]*PasswordAuthentication" /etc/ssh/sshd_config &amp;&amp; sed -i "/^[^#]*PasswordAuthentication[[:space:]]yes/c\PasswordAuthentication no" /etc/ssh/sshd_config || echo "PasswordAuthentication no" &gt;&gt; /etc/ssh/sshd_config
# systemctl restart sshd
</code></pre></div></div>

<h2 id="disk-setup">Disk Setup</h2>

<p>We need to format our disk drive and mount it before we can share it on the network.</p>

<p>Format Disk to ext4</p>
<pre>
# mkfs.ext4 /dev/sd<b>&lt;X&gt;</b>1
</pre>

<p>Create NFS mountpoint</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># mkdir /media/nfs
</code></pre></div></div>

<p>Mount Disk</p>
<pre>
# mount /dev/sd<b>&lt;X&gt;</b>1 /media/nfs
</pre>

<p>Mounting at boot</p>
<pre>
# echo "/dev/sd<b>&lt;X&gt;</b>1 /media/nfs ext4 defaults 0 0" &gt;&gt; /etc/fstab
</pre>

<h2 id="nfs-server-setup">NFS Server Setup</h2>
<p>NFS is a client/server application which allows us to share directories over the network.</p>

<p>Install NFS server</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># apt-get update -y &amp;&amp; apt-get install nfs-kernel-server
</code></pre></div></div>

<p>Add directory to <code class="highlighter-rouge">/etc/exports</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo "/media/nfs *(ro,all_squash,insecure)" &gt;&gt; /etc/exports
</code></pre></div></div>

<p>Re-export changes</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># exportfs -arv
</code></pre></div></div>

<h2 id="nfs-client-setup">NFS Client Setup</h2>

<p>Install the components required for the NFS client</p>

<p>Arch:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -Syu nfs-utils
</code></pre></div></div>

<p>Ubuntu:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># apt-get install nfs-common
</code></pre></div></div>

<p>Create a mountpoint</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># mkdir /media/nfs /media/nfs
</code></pre></div></div>

<p>Mount the NFS share on the client</p>
<pre>
# mount raspberrypi.local:/media/nfs /media/nfs
</pre>

<p>Mounting at boot</p>
<pre>
# echo "raspberrypi.local:/media/nfs /media/nfs nfs defaults 0 0" &gt;&gt; /etc/fstab
</pre>

<h2 id="software-used">Software used</h2>
<ul>
  <li><a href="https://tools.ietf.org/html/rfc7530">nfs</a></li>
  <li><a href="https://www.openssh.com/">ssh</a></li>
</ul>

<h2 id="conclusion">Conclusion</h2>
<p>The latest Raspberry Pi now has USB 3 as well as Gigabit networking which is a vast improvement over the previous models. The ability to create high throughput network storage with Raspberry Pis is now possible.</p>

<p>NFS is not fast by default. Optimisations can improve performance. Other protocols (e.g. rsync) may offer better performance.</p>

<p>This was a quick tutorial on how to setup NFS. The next steps are to secure the  NFS share. Overall it was a successful project. It was cheaper than a pre-built NAS box.</p>

								

<style>
#share-buttons {display: flex; display: flex; align-items: center; justify-content: center; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 62px; 
    width: 62px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 32px; fill: #1A222C; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 36px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 40px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 38px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 40px; margin-top: 9px;}
#share-buttons > div.mail > svg {height: 28px; margin-top: 11px;}
</style>

<div id="share-buttons">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=http://localhost:4000/tech/2019/08/31/Raspberry-Pi-4-Network-Attached-Storage.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('http://twitter.com/home?status=http://localhost:4000/tech/2019/08/31/Raspberry-Pi-4-Network-Attached-Storage.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/tech/2019/08/31/Raspberry-Pi-4-Network-Attached-Storage.html&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
    <div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=http://localhost:4000/tech/2019/08/31/Raspberry-Pi-4-Network-Attached-Storage.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>

            </div>
        </section>
    </div>
    <footer class="footer">
    <p>Rosh Beedassee</p>
</footer>
<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="//cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="/js/app.js"></script>

<!-- Matomo -->
<script type="text/javascript">
    var _paq = _paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
        var u="//matomo-analytics.herokuapp.com/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
    })();
</script>
<!-- End Matomo Code -->

</body>

</html>
